(()=>{var m=!1,l="",d="http://localhost:3000/api";chrome.storage.sync.get(["devMode","currentTestDataId","useLocalApi"],t=>{m=t.devMode||!1,l=t.currentTestDataId||"",d=t.useLocalApi?"http://localhost:3000/api":"https://nhitw-mock-api.vercel.app/api",console.log("\u521D\u59CB\u5316\u958B\u767C\u6A21\u5F0F\u8A2D\u5B9A:",m,l,"\u4F7F\u7528 API:",d)});var o={medicationData:null,labData:null,chinesemedData:null,imagingData:null,allergyData:null,surgeryData:null,dischargeData:null,medDaysData:null,patientSummaryData:null,token:null,currentUserSession:null},D={allergy:"medcloud2.nhi.gov.tw/imu/api/imue0040/imue0040s02/get-data",surgery:"medcloud2.nhi.gov.tw/imu/api/imue0020/imue0020s02/get-data",discharge:"medcloud2.nhi.gov.tw/imu/api/imue0070/imue0070s02/get-data",medDays:"medcloud2.nhi.gov.tw/imu/api/imue0120/imue0120s01/pres-med-day",patientSummary:"medcloud2.nhi.gov.tw/imu/api/imue2000/imue2000s01/get-summary"};Object.entries(D).forEach(([t,u])=>{chrome.webRequest.onBeforeRequest.addListener(function(r){return r.method==="GET"&&r.url.includes(u)&&(console.log(`Detected ${t} API request:`,r.url),chrome.tabs.sendMessage(r.tabId,{action:"apiCallDetected",url:r.url,type:t})),{cancel:!1}},{urls:[`https://${u}*`]},["requestBody"]),chrome.webRequest.onCompleted.addListener(function(r){r.method==="GET"&&r.url.includes(u)&&(console.log(`Completed ${t} API request:`,r.url),chrome.tabs.sendMessage(r.tabId,{action:"apiCallCompleted",url:r.url,statusCode:r.statusCode,type:t}))},{urls:[`https://${u}*`]},["responseHeaders"])});chrome.webRequest.onBeforeRequest.addListener(function(t){return t.method==="GET"&&t.url.includes("medcloud2.nhi.gov.tw/imu/api/imue0090/imue0090s02/get-data")&&chrome.tabs.sendMessage(t.tabId,{action:"apiCallDetected",url:t.url,type:"chinesemed"}),{cancel:!1}},{urls:["https://medcloud2.nhi.gov.tw/imu/api/imue0090/imue0090s02/get-data*"]},["requestBody"]);chrome.webRequest.onBeforeRequest.addListener(function(t){return t.method==="GET"&&t.url.includes("medcloud2.nhi.gov.tw/imu/api/imue0130/imue0130s02/get-data")&&chrome.tabs.sendMessage(t.tabId,{action:"apiCallDetected",url:t.url,type:"imaging"}),{cancel:!1}},{urls:["https://medcloud2.nhi.gov.tw/imu/api/imue0130/imue0130s02/get-data*"]},["requestBody"]);chrome.webRequest.onCompleted.addListener(function(t){t.method==="GET"&&t.url.includes("medcloud2.nhi.gov.tw/imu/api/imue0090/imue0090s02/get-data")&&chrome.tabs.sendMessage(t.tabId,{action:"apiCallCompleted",url:t.url,statusCode:t.statusCode,type:"chinesemed"})},{urls:["https://medcloud2.nhi.gov.tw/imu/api/imue0090/imue0090s02/get-data*"]},["responseHeaders"]);chrome.webRequest.onCompleted.addListener(function(t){t.method==="GET"&&t.url.includes("medcloud2.nhi.gov.tw/imu/api/imue0130/imue0130s02/get-data")&&chrome.tabs.sendMessage(t.tabId,{action:"apiCallCompleted",url:t.url,statusCode:t.statusCode,type:"imaging"})},{urls:["https://medcloud2.nhi.gov.tw/imu/api/imue0130/imue0130s02/get-data*"]},["responseHeaders"]);chrome.webRequest.onBeforeRequest.addListener(function(t){return t.method==="GET"&&t.url.includes("medcloud2.nhi.gov.tw/imu/api/imue0008/imue0008s02/get-data")&&chrome.tabs.sendMessage(t.tabId,{action:"apiCallDetected",url:t.url,type:"medication"}),{cancel:!1}},{urls:["https://medcloud2.nhi.gov.tw/imu/api/imue0008/imue0008s02/get-data*"]},["requestBody"]);chrome.webRequest.onBeforeRequest.addListener(function(t){return t.method==="GET"&&t.url.includes("medcloud2.nhi.gov.tw/imu/api/imue0060/imue0060s02/get-data")&&chrome.tabs.sendMessage(t.tabId,{action:"apiCallDetected",url:t.url,type:"labdata"}),{cancel:!1}},{urls:["https://medcloud2.nhi.gov.tw/imu/api/imue0060/imue0060s02/get-data*"]},["requestBody"]);chrome.webRequest.onCompleted.addListener(function(t){t.method==="GET"&&t.url.includes("medcloud2.nhi.gov.tw/imu/api/imue0008/imue0008s02/get-data")&&chrome.tabs.sendMessage(t.tabId,{action:"apiCallCompleted",url:t.url,statusCode:t.statusCode,type:"medication"})},{urls:["https://medcloud2.nhi.gov.tw/imu/api/imue0008/imue0008s02/get-data*"]},["responseHeaders"]);chrome.webRequest.onCompleted.addListener(function(t){t.method==="GET"&&t.url.includes("medcloud2.nhi.gov.tw/imu/api/imue0060/imue0060s02/get-data")&&chrome.tabs.sendMessage(t.tabId,{action:"apiCallCompleted",url:t.url,statusCode:t.statusCode,type:"labdata"})},{urls:["https://medcloud2.nhi.gov.tw/imu/api/imue0060/imue0060s02/get-data*"]},["responseHeaders"]);chrome.webRequest.onBeforeRequest.addListener(function(t){return t.method==="GET"&&t.url.includes("medcloud2.nhi.gov.tw/imu/api/imue2000/imue2000s01/get-summary")&&chrome.tabs.sendMessage(t.tabId,{action:"apiCallDetected",url:t.url,type:"patientSummary"}),{cancel:!1}},{urls:["https://medcloud2.nhi.gov.tw/imu/api/imue2000/imue2000s01/get-summary*"]},["requestBody"]);chrome.webRequest.onCompleted.addListener(function(t){t.method==="GET"&&t.url.includes("medcloud2.nhi.gov.tw/imu/api/imue2000/imue2000s01/get-summary")&&chrome.tabs.sendMessage(t.tabId,{action:"apiCallCompleted",url:t.url,statusCode:t.statusCode,type:"patientSummary"})},{urls:["https://medcloud2.nhi.gov.tw/imu/api/imue2000/imue2000s01/get-summary*"]},["responseHeaders"]);chrome.runtime.onMessage.addListener((t,u,r)=>{if(t.action==="updateDevMode")return m=t.value,chrome.storage.sync.set({devMode:t.value}),console.log(`\u958B\u767C\u6A21\u5F0F\u5DF2${t.value?"\u555F\u7528":"\u7981\u7528"}`),r({status:"success"}),!0;if(t.action==="updateApiSource")return d=t.value?"http://localhost:3000/api":"https://nhitw-mock-api.vercel.app/api",console.log(`API \u4F86\u6E90\u5DF2\u66F4\u65B0\u70BA: ${d}`),r({status:"success"}),!0;if(t.action==="fetchTestDataList")return fetch(`${d}/data/list`).then(a=>a.json()).then(a=>{r({status:"success",data:a})}).catch(a=>{console.error("\u7372\u53D6\u6E2C\u8A66\u6578\u64DA\u5217\u8868\u5931\u6557:",a),r({status:"error",error:a.message})}),!0;if(t.action==="updatePopupDataStatus")return chrome.runtime.sendMessage({action:"refreshDataStatus"}),r({status:"success"}),!0;if(t.action==="updateTestDataId")return l=t.value,chrome.storage.sync.set({currentTestDataId:t.value}),console.log("\u6E2C\u8A66\u6578\u64DA ID \u5DF2\u66F4\u65B0:",t.value),r({status:"test_data_id_updated"}),!0;if(t.action==="loadTestData")if(m&&l){console.log("\u6B63\u5728\u8F09\u5165\u6E2C\u8A66\u6578\u64DA...");let a={medication:"medicationData",labdata:"labData",lab:"labData",chinesemed:"chinesemedData",imaging:"imagingData",allergy:"allergyData",surgery:"surgeryData",discharge:"dischargeData",medDays:"medDaysData",patientSummary:"patientSummaryData"},e=`${d}/data/${l}`;return fetch(e).then(n=>{if(!n.ok)throw new Error(`API \u8ACB\u6C42\u5931\u6557: ${n.status} ${n.statusText}`);return n.json()}).then(n=>{console.log("\u6E2C\u8A66\u6578\u64DA\u8F09\u5165\u6210\u529F:",n);let s=[];if(Object.entries(a).forEach(([i,c])=>{n[i]&&(o[c]=n[i],chrome.storage.local.set({[c]:n[i]}),s.push(i),console.log(`\u5DF2\u8F09\u5165 ${i} \u6578\u64DA`))}),s.length===0)throw new Error("\u6C92\u6709\u627E\u5230\u4EFB\u4F55\u53EF\u7528\u7684\u6E2C\u8A66\u6578\u64DA");chrome.action.setBadgeText({text:"\u2713"}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50"}),chrome.tabs.query({},i=>{i.forEach(c=>{c.url&&(c.url.includes("nhi.gov.tw")||c.url.includes("localhost"))&&(console.log(`\u5617\u8A66\u5411\u6A19\u7C64\u9801 ${c.id} \u767C\u9001\u6E2C\u8A66\u6578\u64DA\u8F09\u5165\u6D88\u606F`),chrome.tabs.sendMessage(c.id,{action:"testDataLoaded",dataTypes:s}).catch(g=>console.log(`\u7121\u6CD5\u50B3\u9001\u8A0A\u606F\u5230\u6A19\u7C64\u9801 ${c.id}:`,g)))})}),chrome.notifications.create({type:"basic",iconUrl:"images/icon128.png",title:"\u6E2C\u8A66\u6578\u64DA\u5DF2\u8F09\u5165",message:`\u5DF2\u6210\u529F\u8F09\u5165 ${s.length} \u7A2E\u6E2C\u8A66\u6578\u64DA`,buttons:[{title:"\u78BA\u5B9A"}],priority:2}),r({status:"test_data_loaded",dataTypes:s})}).catch(n=>{console.error("\u6E2C\u8A66\u6578\u64DA\u8F09\u5165\u5931\u6557:",n),chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#F44336"}),r({status:"error",error:n.message})}),!0}else return r({status:"error",error:"\u958B\u767C\u6A21\u5F0F\u672A\u555F\u7528\u6216\u672A\u9078\u64C7\u6E2C\u8A66\u6578\u64DA"}),!0;if(t.action==="getTestData"&&t.dataType)if(m&&l){console.log(`\u6B63\u5728\u7372\u53D6 ${t.dataType} \u6E2C\u8A66\u6578\u64DA...`);let a=`${d}/data/current?type=${t.dataType}&id=${l}`;return fetch(a).then(e=>{if(!e.ok)throw new Error(`API \u8ACB\u6C42\u5931\u6557: ${e.status} ${e.statusText}`);return e.json()}).then(e=>{console.log(`${t.dataType} \u6E2C\u8A66\u6578\u64DA\u7372\u53D6\u6210\u529F:`,e);let n;switch(t.dataType){case"medication":n="medicationData";break;case"labdata":n="labData";break;case"lab":n="labData";break;case"chinesemed":n="chinesemedData";break;case"imaging":n="imagingData";break;case"allergy":n="allergyData";break;case"surgery":n="surgeryData";break;case"discharge":n="dischargeData";break;case"medDays":n="medDaysData";break;case"patientSummary":n="patientSummaryData";break;default:n=`${t.dataType}Data`}if(e[t.dataType])o[n]=e[t.dataType],chrome.storage.local.set({[n]:e[t.dataType]}),chrome.tabs.query({},s=>{s.forEach(i=>{i.url&&(i.url.includes("nhi.gov.tw")||i.url.includes("localhost"))&&(console.log(`\u5617\u8A66\u5411\u6A19\u7C64\u9801 ${i.id} \u767C\u9001 ${t.dataType} \u6578\u64DA\u8F09\u5165\u6D88\u606F`),chrome.tabs.sendMessage(i.id,{action:"testDataTypeLoaded",dataType:t.dataType,storageKey:n}).catch(c=>console.log(`\u7121\u6CD5\u50B3\u9001\u8A0A\u606F\u5230\u6A19\u7C64\u9801 ${i.id}:`,c)))})}),chrome.notifications.create({type:"basic",iconUrl:"images/icon128.png",title:"\u6E2C\u8A66\u6578\u64DA\u5DF2\u8F09\u5165",message:`\u5DF2\u6210\u529F\u8F09\u5165 ${t.dataType} \u6E2C\u8A66\u6578\u64DA`,buttons:[{title:"\u78BA\u5B9A"}],priority:2}),r({status:"success",data:e[t.dataType]});else throw new Error(`\u627E\u4E0D\u5230 ${t.dataType} \u6E2C\u8A66\u6578\u64DA`)}).catch(e=>{console.error(`${t.dataType} \u6E2C\u8A66\u6578\u64DA\u7372\u53D6\u5931\u6557:`,e),r({status:"error",error:e.message})}),!0}else return r({status:"error",error:"\u958B\u767C\u6A21\u5F0F\u672A\u555F\u7528\u6216\u672A\u9078\u64C7\u6E2C\u8A66\u6578\u64DA"}),!0;let h={saveAllergyData:"allergyData",saveSurgeryData:"surgeryData",saveDischargeData:"dischargeData",saveMedDaysData:"medDaysData",savePatientSummaryData:"patientSummaryData"};if(t.action==="openPopup"&&chrome.action.openPopup(),Object.keys(h).includes(t.action)){let a=h[t.action];return o[a]=t.data,o.currentUserSession=t.userSession||o.currentUserSession,chrome.storage.local.set({[a]:t.data,currentUserSession:t.userSession||o.currentUserSession},function(){chrome.action.setBadgeText({text:"\u2713"}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50"}),t.data&&t.data.rObject&&Array.isArray(t.data.rObject)?r({status:"saved",recordCount:t.data.rObject.length}):r({status:"saved",recordCount:0,error:"Invalid data format"})}),!0}return t.action==="saveChineseMedData"?(o.chinesemedData=t.data,o.currentUserSession=t.userSession||o.currentUserSession,chrome.storage.local.set({chinesemedData:t.data,currentUserSession:t.userSession||o.currentUserSession},function(){chrome.action.setBadgeText({text:"\u2713"}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50"}),t.data&&t.data.rObject&&Array.isArray(t.data.rObject)?r({status:"saved",recordCount:t.data.rObject.length}):r({status:"saved",recordCount:0,error:"Invalid data format"})}),!0):t.action==="saveImagingData"?(o.imagingData=t.data,o.currentUserSession=t.userSession||o.currentUserSession,chrome.storage.local.set({imagingData:t.data,currentUserSession:t.userSession||o.currentUserSession},function(){chrome.action.setBadgeText({text:"\u2713"}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50"}),t.data&&t.data.rObject&&Array.isArray(t.data.rObject)?r({status:"saved",recordCount:t.data.rObject.length}):r({status:"saved",recordCount:0,error:"Invalid data format"})}),!0):t.action==="userSessionChanged"?(o={medicationData:null,labData:null,token:null,currentUserSession:t.userSession},chrome.storage.local.remove(["medicationData","labData","currentUserSession"],function(){chrome.action.setBadgeText({text:""})}),r({status:"session_reset"}),!0):t.action==="clearSessionData"?(o={medicationData:null,labData:null,token:null,currentUserSession:null},r({status:"cleared"}),!0):(t.userSession&&t.userSession!==o.currentUserSession&&(o={medicationData:null,labData:null,token:null,currentUserSession:t.userSession}),t.action==="saveMedicationData"?(o.medicationData=t.data,o.currentUserSession=t.userSession||o.currentUserSession,chrome.storage.local.set({medicationData:t.data,currentUserSession:t.userSession||o.currentUserSession},function(){chrome.action.setBadgeText({text:"\u2713"}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50"}),t.data&&t.data.rObject&&Array.isArray(t.data.rObject)?r({status:"saved",recordCount:t.data.rObject.length}):r({status:"saved",recordCount:0,error:"Invalid data format"})}),!0):t.action==="saveLabData"?(o.labData=t.data,o.currentUserSession=t.userSession||o.currentUserSession,chrome.storage.local.set({labData:t.data,currentUserSession:t.userSession||o.currentUserSession},function(){chrome.action.setBadgeText({text:"\u2713"}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50"}),t.data&&t.data.rObject&&Array.isArray(t.data.rObject)?r({status:"saved",recordCount:t.data.rObject.length}):r({status:"saved",recordCount:0,error:"Invalid data format"})}),!0):t.action==="saveToken"?(o.token=t.token,o.currentUserSession=t.userSession||o.currentUserSession,r({status:"token_saved"}),!0):t.action==="getSessionData"?(r({status:"success",data:o}),!0):t.action==="getDataStatus"?(console.log("\u8655\u7406 getDataStatus \u8ACB\u6C42"),chrome.storage.local.get(["medicationData","labData","chinesemedData","imagingData","allergyData","surgeryData","dischargeData","medDaysData","patientSummaryData"],a=>{console.log("STORAGE DATA DEBUG:",a);let e={};a.medicationData?a.medicationData.rObject?e.medication={status:"fetched",count:a.medicationData.rObject.length}:Array.isArray(a.medicationData)?e.medication={status:"fetched",count:a.medicationData.length}:e.medication={status:"fetched",count:1}:e.medication={status:"none",count:0},a.labData?a.labData.rObject?e.labData={status:"fetched",count:a.labData.rObject.length}:Array.isArray(a.labData)?e.labData={status:"fetched",count:a.labData.length}:e.labData={status:"fetched",count:1}:e.labData={status:"none",count:0},a.chinesemedData?a.chinesemedData.rObject?e.chineseMed={status:"fetched",count:a.chinesemedData.rObject.length}:Array.isArray(a.chinesemedData)?e.chineseMed={status:"fetched",count:a.chinesemedData.length}:e.chineseMed={status:"fetched",count:1}:e.chineseMed={status:"none",count:0},a.imagingData?(console.log("IMAGING DEBUG:",a.imagingData),a.imagingData.rObject?e.imaging={status:"fetched",count:a.imagingData.rObject.length}:Array.isArray(a.imagingData)?e.imaging={status:"fetched",count:a.imagingData.length}:e.imaging={status:"fetched",count:1}):(console.log("IMAGING NOT FOUND OR INVALID FORMAT:",a.imagingData),e.imaging={status:"none",count:0}),a.allergyData?a.allergyData.rObject?e.allergy={status:"fetched",count:a.allergyData.rObject.length}:Array.isArray(a.allergyData)?e.allergy={status:"fetched",count:a.allergyData.length}:e.allergy={status:"fetched",count:1}:e.allergy={status:"none",count:0},a.surgeryData?a.surgeryData.rObject?e.surgery={status:"fetched",count:a.surgeryData.rObject.length}:Array.isArray(a.surgeryData)?e.surgery={status:"fetched",count:a.surgeryData.length}:e.surgery={status:"fetched",count:1}:e.surgery={status:"none",count:0},a.dischargeData?a.dischargeData.rObject?e.discharge={status:"fetched",count:a.dischargeData.rObject.length}:Array.isArray(a.dischargeData)?e.discharge={status:"fetched",count:a.dischargeData.length}:e.discharge={status:"fetched",count:1}:e.discharge={status:"none",count:0},a.medDaysData?a.medDaysData.rObject?e.medDays={status:"fetched",count:a.medDaysData.rObject.length}:Array.isArray(a.medDaysData)?e.medDays={status:"fetched",count:a.medDaysData.length}:e.medDays={status:"fetched",count:1}:e.medDays={status:"none",count:0},a.patientSummaryData?a.patientSummaryData.rObject?e.patientSummary={status:"fetched",count:a.patientSummaryData.rObject.length}:a.patientSummaryData.robject?e.patientSummary={status:"fetched",count:a.patientSummaryData.robject.length}:Array.isArray(a.patientSummaryData)?e.patientSummary={status:"fetched",count:a.patientSummaryData.length}:e.patientSummary={status:"fetched",count:1}:e.patientSummary={status:"none",count:0},console.log("\u56DE\u50B3\u7684\u6578\u64DA\u72C0\u614B:",e),r({dataStatus:e})}),!0):t.action==="updateDataStatus"?(console.log("\u6536\u5230\u6578\u64DA\u72C0\u614B\u66F4\u65B0\u8ACB\u6C42"),chrome.tabs.query({},a=>{a.forEach(e=>{e.url&&(e.url.includes("nhi.gov.tw")||e.url.includes("localhost"))&&chrome.tabs.sendMessage(e.id,{action:"dataStatusUpdated"}).catch(n=>console.log(`\u7121\u6CD5\u50B3\u9001\u8A0A\u606F\u5230\u6A19\u7C64\u9801 ${e.id}:`,n))})}),chrome.action.setBadgeText({text:"\u2713"}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50"}),r({status:"data_status_updated"}),!0):(t.action==="clearData"&&(o={medicationData:null,labData:null,chinesemedData:null,imagingData:null,allergyData:null,surgeryData:null,dischargeData:null,medDaysData:null,patientSummaryData:null,token:null,currentUserSession:t.userSession},chrome.storage.local.remove(["medicationData","labData","chinesemedData","imagingData","allergyData","surgeryData","dischargeData","medDaysData","patientSummaryData","currentUserSession"],function(){chrome.action.setBadgeText({text:""}),r({status:"cleared"})})),t.action==="resetData"&&(o={medicationData:null,labData:null,chinesemedData:null,imagingData:null,allergyData:null,surgeryData:null,dischargeData:null,medDaysData:null,patientSummaryData:null,token:null,currentUserSession:null}),r({status:"received"}),!0))});chrome.tabs.onUpdated.addListener((t,u,r)=>{u.url&&(u.url.includes("medcloud2.nhi.gov.tw/imu/login")||u.url.includes("medcloud2.nhi.gov.tw/imu/IMUE1000/IMUE0001"))&&(console.log("Detected navigation to login page, clearing session data"),o={medicationData:null,labData:null,token:null,currentUserSession:null},chrome.storage.local.remove(["medicationData","labData","currentUserSession"],function(){console.log("Storage data cleared due to logout"),chrome.action.setBadgeText({text:""})}))});})();
