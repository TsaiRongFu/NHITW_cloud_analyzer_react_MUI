(()=>{var d=!1,l="",c="https://nhitw-mock-api.vercel.app/api";chrome.storage.sync.get(["devMode","currentTestDataId","useLocalApi"],e=>{d=e.devMode||!1,l=e.currentTestDataId||"",c=e.useLocalApi?"http://localhost:3000/api":"https://nhitw-mock-api.vercel.app/api",console.log("\u521D\u59CB\u5316\u958B\u767C\u6A21\u5F0F\u8A2D\u5B9A:",d,l,"\u4F7F\u7528 API:",c)});var h={medicationData:null,labData:null,chinesemedData:null,imagingData:null,allergyData:null,surgeryData:null,dischargeData:null,medDaysData:null,patientSummaryData:null,token:null,currentUserSession:null},y={allergy:"medcloud2.nhi.gov.tw/imu/api/imue0040/imue0040s02/get-data",surgery:"medcloud2.nhi.gov.tw/imu/api/imue0020/imue0020s02/get-data",discharge:"medcloud2.nhi.gov.tw/imu/api/imue0070/imue0070s02/get-data",medDays:"medcloud2.nhi.gov.tw/imu/api/imue0120/imue0120s01/pres-med-day",patientSummary:"medcloud2.nhi.gov.tw/imu/api/imue2000/imue2000s01/get-summary",medication:"medcloud2.nhi.gov.tw/imu/api/imue0008/imue0008s02/get-data",labdata:"medcloud2.nhi.gov.tw/imu/api/imue0060/imue0060s02/get-data",chinesemed:"medcloud2.nhi.gov.tw/imu/api/imue0090/imue0090s02/get-data",imaging:"medcloud2.nhi.gov.tw/imu/api/imue0130/imue0130s02/get-data"};function f(e){return e&&e.includes("medcloud2.nhi.gov.tw")}function D(e){return e&&(e.includes("nhitw-mock-api.vercel.app")||e.includes("localhost"))}function m(e,s,t){chrome.tabs.get(e,o=>{if(chrome.runtime.lastError){console.warn(`\u7121\u6CD5\u767C\u9001\u8A0A\u606F\u5230\u6A19\u7C64\u9801 ${e}: ${chrome.runtime.lastError.message}`),t&&t({error:chrome.runtime.lastError.message});return}if(o.status!=="complete"){console.warn(`\u6A19\u7C64\u9801 ${e} \u5C1A\u672A\u5B8C\u6210\u8F09\u5165\uFF0C\u7B49\u5F85\u5F8C\u518D\u5617\u8A66\u767C\u9001\u8A0A\u606F`),setTimeout(()=>{m(e,s,t)},500);return}try{chrome.tabs.sendMessage(e,s,r=>{if(chrome.runtime.lastError){console.warn(`\u767C\u9001\u8A0A\u606F\u5230\u6A19\u7C64\u9801 ${e} \u5931\u6557: ${chrome.runtime.lastError.message}`),chrome.runtime.lastError.message.includes("Receiving end does not exist")?(console.log(`\u5617\u8A66\u91CD\u65B0\u6CE8\u5165 content script \u5230\u6A19\u7C64\u9801 ${e}`),t&&t({status:"retry",message:"\u63A5\u6536\u7AEF\u4E0D\u5B58\u5728\uFF0C\u53EF\u80FD\u9700\u8981\u91CD\u65B0\u8F09\u5165\u9801\u9762"})):t&&t({error:chrome.runtime.lastError.message});return}t&&t(r||{status:"success"})})}catch(r){console.error(`\u767C\u9001\u8A0A\u606F\u5230\u6A19\u7C64\u9801 ${e} \u6642\u767C\u751F\u7570\u5E38:`,r),t&&t({error:r.message})}})}function p(e,s,t,o){chrome.tabs.query({},r=>{let a=r.filter(u=>D(u.url));if(a.length===0){console.log("\u627E\u4E0D\u5230\u6E2C\u8A66\u74B0\u5883\u6A19\u7C64\u9801\uFF0C\u7121\u6CD5\u901A\u77E5\u6578\u64DA\u8F09\u5165"),o&&o({status:"warning",message:"\u627E\u4E0D\u5230\u6E2C\u8A66\u74B0\u5883\u6A19\u7C64\u9801"});return}console.log(`\u627E\u5230 ${a.length} \u500B\u6E2C\u8A66\u74B0\u5883\u6A19\u7C64\u9801\uFF0C\u958B\u59CB\u901A\u77E5\u6578\u64DA\u8F09\u5165`);let i=0,n=0;a.forEach((u,v)=>{m(u.id,e,g=>{g&&g.error?(console.warn(`\u901A\u77E5\u6A19\u7C64\u9801 ${u.id} \u5931\u6557:`,g.error),n++):(console.log(`\u6210\u529F\u901A\u77E5\u6A19\u7C64\u9801 ${u.id}`),i++),i+n===a.length&&o&&o({status:n===0?"success":"partial",message:`\u5DF2\u901A\u77E5 ${i} \u500B\u6A19\u7C64\u9801\uFF0C${n} \u500B\u5931\u6557`,successCount:i,errorCount:n})})})})}function T(){Object.entries(y).forEach(([e,s])=>{chrome.webRequest.onBeforeRequest.addListener(function(t){return t.method==="GET"&&t.url.includes(s)&&(console.log(`\u5075\u6E2C\u5230 ${e} API \u8ACB\u6C42:`,t.url),chrome.tabs.sendMessage(t.tabId,{action:"apiCallDetected",url:t.url,type:e})),{cancel:!1}},{urls:[`https://${s}*`]},["requestBody"]),chrome.webRequest.onCompleted.addListener(function(t){t.method==="GET"&&t.url.includes(s)&&(console.log(`\u5B8C\u6210 ${e} API \u8ACB\u6C42:`,t.url),chrome.tabs.sendMessage(t.tabId,{action:"apiCallCompleted",url:t.url,statusCode:t.statusCode,type:e}))},{urls:[`https://${s}*`]},["responseHeaders"])})}T();chrome.runtime.onMessage.addListener((e,s,t)=>{if(e.action==="updateDevMode")return d=e.value,chrome.storage.sync.set({devMode:e.value}),console.log("\u958B\u767C\u6A21\u5F0F\u5DF2\u66F4\u65B0:",d),t({status:"success"}),!0;if(e.action==="updateCurrentTestDataId")return l=e.value,chrome.storage.sync.set({currentTestDataId:e.value}),console.log("\u7576\u524D\u6E2C\u8A66\u6578\u64DA ID \u5DF2\u66F4\u65B0:",l),t({status:"success"}),!0;if(e.action==="updateApiEndpoint")return c=e.useLocalApi?"http://localhost:3000/api":"https://nhitw-mock-api.vercel.app/api",chrome.storage.sync.set({useLocalApi:e.useLocalApi}),console.log("API \u7AEF\u9EDE\u5DF2\u66F4\u65B0:",c),t({status:"success"}),!0;if(e.action==="loadTestData")if(d&&l){console.log("\u6B63\u5728\u8F09\u5165\u6E2C\u8A66\u6578\u64DA...");let o={medication:"medicationData",labdata:"labData",chinesemed:"chinesemedData",imaging:"imagingData",allergy:"allergyData",surgery:"surgeryData",discharge:"dischargeData",medDays:"medDaysData",patientSummary:"patientSummaryData"},r=`${c}/data/${l}`;return console.log("\u8ACB\u6C42 URL:",r),fetch(r).then(a=>{if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);return a.json()}).then(a=>{console.log("\u6E2C\u8A66\u6578\u64DA\u8F09\u5165\u6210\u529F:",a);let i={};Object.entries(o).forEach(([n,u])=>{a[n]&&(i[u]=a[n],console.log(`\u4FDD\u5B58 ${n} \u6578\u64DA\u5230\u5B58\u5132`))}),chrome.storage.local.set(i,()=>{console.log("\u6240\u6709\u6E2C\u8A66\u6578\u64DA\u5DF2\u4FDD\u5B58\u5230 Chrome \u5B58\u5132"),chrome.tabs.query({active:!0,currentWindow:!0},n=>{n.length>0?m(n[0].id,{action:"testDataLoaded",dataTypes:Object.keys(i)},u=>{t({status:"test_data_loaded",dataTypes:Object.keys(i)})}):t({status:"test_data_loaded",dataTypes:Object.keys(i)})})})}).catch(a=>{console.error("\u8F09\u5165\u6E2C\u8A66\u6578\u64DA\u6642\u51FA\u932F:",a),t({status:"error",error:`\u8F09\u5165\u6E2C\u8A66\u6578\u64DA\u6642\u51FA\u932F: ${a.message}`})}),!0}else return t({status:"error",error:"\u672A\u555F\u7528\u958B\u767C\u6A21\u5F0F\u6216\u672A\u8A2D\u5B9A\u6E2C\u8A66\u6578\u64DA ID"}),!1;if(e.action==="getTestData"&&e.dataType)if(d&&l){console.log(`\u6B63\u5728\u7372\u53D6 ${e.dataType} \u6E2C\u8A66\u6578\u64DA...`);let o=`${c}/data/${l}?type=${e.dataType}`;return fetch(o).then(r=>{if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return r.json()}).then(r=>{console.log(`${e.dataType} \u6E2C\u8A66\u6578\u64DA\u8F09\u5165\u6210\u529F:`,r);let a;switch(e.dataType){case"medication":a="medicationData";break;case"labdata":a="labData";break;case"chinesemed":a="chinesemedData";break;case"imaging":a="imagingData";break;case"allergy":a="allergyData";break;case"surgery":a="surgeryData";break;case"discharge":a="dischargeData";break;case"medDays":a="medDaysData";break;case"patientSummary":a="patientSummaryData";break;default:throw new Error(`\u672A\u77E5\u7684\u6578\u64DA\u985E\u578B: ${e.dataType}`)}let i={};i[a]=r[e.dataType],chrome.storage.local.set(i,()=>{console.log(`${e.dataType} \u6E2C\u8A66\u6578\u64DA\u5DF2\u4FDD\u5B58\u5230 Chrome \u5B58\u5132`),p({action:"testDataTypeLoaded",dataType:e.dataType,storageKey:a},e.dataType,a,n=>{t({status:"success",message:`${e.dataType} \u6E2C\u8A66\u6578\u64DA\u5DF2\u8F09\u5165`,notifyResult:n})})})}).catch(r=>{console.error(`\u8F09\u5165 ${e.dataType} \u6E2C\u8A66\u6578\u64DA\u6642\u51FA\u932F:`,r),t({status:"error",error:r.message})}),!0}else return t({status:"error",error:"\u672A\u555F\u7528\u958B\u767C\u6A21\u5F0F\u6216\u672A\u8A2D\u5B9A\u6E2C\u8A66\u6578\u64DA ID"}),!1;if(e.action==="updateDataStatus")return console.log("\u6536\u5230\u6578\u64DA\u72C0\u614B\u66F4\u65B0\u8ACB\u6C42"),chrome.tabs.query({active:!0,currentWindow:!0},o=>{if(o.length>0){let r=o[0];f(r.url)||D(r.url)?m(r.id,{action:"dataStatusUpdated"},a=>{a&&!a.error?(console.log("\u6578\u64DA\u72C0\u614B\u66F4\u65B0\u901A\u77E5\u5DF2\u767C\u9001\uFF0C\u56DE\u61C9:",a),t({status:"success",message:"\u6578\u64DA\u72C0\u614B\u5DF2\u66F4\u65B0"})):(console.log("\u6578\u64DA\u72C0\u614B\u66F4\u65B0\u901A\u77E5\u767C\u9001\u5931\u6557:",a?.error),t({status:"error",error:a?.error||"\u7121\u6CD5\u901A\u77E5\u5167\u5BB9\u8173\u672C"}))}):(console.log("\u7576\u524D\u4E0D\u5728\u652F\u63F4\u7684\u74B0\u5883\u4E2D\uFF0C\u4E0D\u767C\u9001\u6578\u64DA\u72C0\u614B\u66F4\u65B0\u901A\u77E5"),t({status:"error",error:"\u7576\u524D\u4E0D\u5728\u652F\u63F4\u7684\u74B0\u5883\u4E2D"}))}else console.log("\u627E\u4E0D\u5230\u7576\u524D\u6A19\u7C64\u9801"),t({status:"error",error:"\u627E\u4E0D\u5230\u7576\u524D\u6A19\u7C64\u9801"})}),!0;if(e.action==="fetchTestDataList"){console.log("\u6536\u5230\u7372\u53D6\u6E2C\u8A66\u6578\u64DA\u5217\u8868\u8ACB\u6C42");let o=`${c}/data/list`;return console.log("\u8ACB\u6C42\u6E2C\u8A66\u6578\u64DA\u5217\u8868 URL:",o),fetch(o).then(r=>{if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return r.json()}).then(r=>{console.log("\u6E2C\u8A66\u6578\u64DA\u5217\u8868\u7372\u53D6\u6210\u529F:",r),t({status:"success",data:r})}).catch(r=>{console.error("\u7372\u53D6\u6E2C\u8A66\u6578\u64DA\u5217\u8868\u6642\u51FA\u932F:",r),t({status:"error",error:r.message})}),!0}return e.action==="clearData"&&(h={medicationData:null,labData:null,chinesemedData:null,imagingData:null,allergyData:null,surgeryData:null,dischargeData:null,medDaysData:null,patientSummaryData:null,token:null,currentUserSession:e.userSession},chrome.storage.local.remove(["medicationData","labData","chinesemedData","imagingData","allergyData","surgeryData","dischargeData","medDaysData","patientSummaryData","currentUserSession"],function(){chrome.action.setBadgeText({text:""}),t({status:"cleared"})})),e.action==="resetData"&&(h={medicationData:null,labData:null,chinesemedData:null,imagingData:null,allergyData:null,surgeryData:null,dischargeData:null,medDaysData:null,patientSummaryData:null,token:null,currentUserSession:null}),t({status:"received"}),!0});chrome.tabs.onUpdated.addListener((e,s,t)=>{s.url&&(s.url.includes("medcloud2.nhi.gov.tw/imu/login")||s.url.includes("medcloud2.nhi.gov.tw/imu/IMUE1000/IMUE0001"))&&(console.log("Detected navigation to login page, clearing session data"),h={medicationData:null,labData:null,token:null,currentUserSession:null},chrome.storage.local.remove(["medicationData","labData","currentUserSession"],function(){console.log("Storage data cleared due to logout"),chrome.action.setBadgeText({text:""})}))});})();
